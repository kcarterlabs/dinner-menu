name: Build Docker Images

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
    
    env:
      ECR_REGISTRY_BACKEND: ${{ secrets.ECR_REGISTRY_BACKEND }}
      ECR_REGISTRY_FRONTEND: ${{ secrets.ECR_REGISTRY_FRONTEND }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2
      
      - name: Log in to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push backend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_BACKEND }}
        run: |
          set -euo pipefail
          echo "Building backend image..."
          # Build and push backend with SHA tag
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG . && \
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG && \
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest && \
          docker push $REGISTRY/$REPOSITORY:latest
          echo "✅ Backend image pushed successfully"
      
      - name: Build, tag, and push frontend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_FRONTEND }}
        run: |
          set -euo pipefail
          echo "Building frontend image..."
          # Build and push frontend with SHA tag
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG . && \
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG && \
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest && \
          docker push $REGISTRY/$REPOSITORY:latest
          echo "✅ Frontend image pushed successfully"
      
      - name: Build summary
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker images built and pushed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
