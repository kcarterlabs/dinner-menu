name: Build Docker Images

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Secret scan results
        if: success()
        run: echo "âœ… No secrets detected in codebase"

  test:
    name: Run Tests
    needs: secret-scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests (unit + integration + e2e)..."
          python -m pytest tests/ -v --cov=. --cov-report=term --cov-report=xml
          echo "âœ… All tests passed"
      
      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  build:
    name: Build and Push Docker Images
    needs: [secret-scan, test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
    
    env:
      ECR_REGISTRY_BACKEND: ${{ secrets.ECR_REGISTRY_BACKEND }}
      ECR_REGISTRY_FRONTEND: ${{ secrets.ECR_REGISTRY_FRONTEND }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2
      
      - name: Log in to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Verify ECR repositories exist
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "Verifying ECR repositories..."
          echo "Registry: ${{ steps.login-ecr.outputs.registry }}"
          echo "Backend repo: ${{ secrets.ECR_REGISTRY_BACKEND }}"
          echo "Frontend repo: ${{ secrets.ECR_REGISTRY_FRONTEND }}"
          
          # Check if repositories exist
          if ! aws ecr describe-repositories --repository-names ${{ secrets.ECR_REGISTRY_BACKEND }} --region us-west-2 > /dev/null 2>&1; then
            echo "âŒ ERROR: Backend repository '${{ secrets.ECR_REGISTRY_BACKEND }}' does not exist!"
            echo "Create it with: aws ecr create-repository --repository-name ${{ secrets.ECR_REGISTRY_BACKEND }} --region us-west-2"
            exit 1
          fi
          
          if ! aws ecr describe-repositories --repository-names ${{ secrets.ECR_REGISTRY_FRONTEND }} --region us-west-2 > /dev/null 2>&1; then
            echo "âŒ ERROR: Frontend repository '${{ secrets.ECR_REGISTRY_FRONTEND }}' does not exist!"
            echo "Create it with: aws ecr create-repository --repository-name ${{ secrets.ECR_REGISTRY_FRONTEND }} --region us-west-2"
            exit 1
          fi
          
          echo "âœ… Both ECR repositories exist"
      
      - name: Build, tag, and push backend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_BACKEND }}
        run: |
          set -euo pipefail
          echo "Building backend image..."
          echo "Target: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          # Build and push backend with SHA tag
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG . || { echo "âŒ Backend build failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG || { echo "âŒ Backend push failed"; exit 1; }
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest || { echo "âŒ Backend tag failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:latest || { echo "âŒ Backend push latest failed"; exit 1; }
          echo "âœ… Backend image pushed successfully"
      
      - name: Build, tag, and push frontend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_FRONTEND }}
        run: |
          set -euo pipefail
          echo "Building frontend image..."
          echo "Target: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          # Build and push frontend with SHA tag using Dockerfile.frontend
          docker build -f Dockerfile.frontend -t $REGISTRY/$REPOSITORY:$IMAGE_TAG . || { echo "âŒ Frontend build failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG || { echo "âŒ Frontend push failed"; exit 1; }
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest || { echo "âŒ Frontend tag failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:latest || { echo "âŒ Frontend push latest failed"; exit 1; }
          echo "âœ… Frontend image pushed successfully"
      
      - name: Build summary
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker images built and pushed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
