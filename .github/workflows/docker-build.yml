name: Build Docker Images

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      
      - name: Secret scan results
        if: success()
        run: echo "âœ… No secrets detected in codebase"

  test:
    name: Run Tests
    needs: secret-scan
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: changeme123
          MONGO_INITDB_DATABASE: dinner_menu
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand(\"ping\").ok' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Install MongoDB tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh
      
      - name: Set environment variables for tests
        run: |
          echo "MONGO_PASSWORD=changeme123" >> $GITHUB_ENV
          echo "MONGODB_DATABASE=dinner_menu" >> $GITHUB_ENV
          echo "USE_MONGODB=true" >> $GITHUB_ENV
      
      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          timeout 30 bash -c 'until mongosh --host localhost --port 27017 --username admin --password changeme123 --eval "db.runCommand(\"ping\").ok" --quiet; do sleep 1; done'
          echo "âœ… MongoDB is ready"
      
      - name: Run Python tests
        run: |
          echo "ðŸ§ª Running Python backend tests..."
          python -m pytest tests/ -v --cov=. --cov-report=term --cov-report=xml
          echo "âœ… Backend tests passed"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vue-frontend/package-lock.json
      
      - name: Install Vue frontend dependencies
        run: |
          cd vue-frontend
          npm ci
      
      - name: Run Vue frontend tests
        run: |
          cd vue-frontend
          echo "ðŸ§ª Running Vue.js frontend tests..."
          npm test -- --run
          echo "âœ… Frontend tests passed"
      
      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  build:
    name: Build and Push Docker Images
    needs: [secret-scan, test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
    
    env:
      ECR_REGISTRY_BACKEND: ${{ secrets.ECR_REGISTRY_BACKEND }}
      ECR_REGISTRY_FRONTEND: ${{ secrets.ECR_REGISTRY_FRONTEND }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2
      
      - name: Log in to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Verify ECR repositories exist
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "Verifying ECR repositories..."
          echo "Registry: ${{ steps.login-ecr.outputs.registry }}"
          echo "Backend repo: ${{ secrets.ECR_REGISTRY_BACKEND }}"
          echo "Frontend repo: ${{ secrets.ECR_REGISTRY_FRONTEND }}"
          
          # Check if repositories exist
          if ! aws ecr describe-repositories --repository-names ${{ secrets.ECR_REGISTRY_BACKEND }} --region us-west-2 > /dev/null 2>&1; then
            echo "âŒ ERROR: Backend repository '${{ secrets.ECR_REGISTRY_BACKEND }}' does not exist!"
            echo "Create it with: aws ecr create-repository --repository-name ${{ secrets.ECR_REGISTRY_BACKEND }} --region us-west-2"
            exit 1
          fi
          
          if ! aws ecr describe-repositories --repository-names ${{ secrets.ECR_REGISTRY_FRONTEND }} --region us-west-2 > /dev/null 2>&1; then
            echo "âŒ ERROR: Frontend repository '${{ secrets.ECR_REGISTRY_FRONTEND }}' does not exist!"
            echo "Create it with: aws ecr create-repository --repository-name ${{ secrets.ECR_REGISTRY_FRONTEND }} --region us-west-2"
            exit 1
          fi
          
          echo "âœ… Both ECR repositories exist"
      
      - name: Build, tag, and push backend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_BACKEND }}
        run: |
          set -euo pipefail
          echo "Building backend image..."
          echo "Target: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          # Build and push backend with SHA tag
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG . || { echo "âŒ Backend build failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG || { echo "âŒ Backend push failed"; exit 1; }
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest || { echo "âŒ Backend tag failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:latest || { echo "âŒ Backend push latest failed"; exit 1; }
          echo "âœ… Backend image pushed successfully"
      
      - name: Build, tag, and push frontend image to Amazon ECR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ secrets.ECR_REGISTRY_FRONTEND }}
        run: |
          set -euo pipefail
          echo "Building Vue.js frontend image..."
          echo "Target: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          # Build and push Vue frontend with SHA tag using production Dockerfile
          docker build -f vue-frontend/Dockerfile -t $REGISTRY/$REPOSITORY:$IMAGE_TAG ./vue-frontend || { echo "âŒ Frontend build failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG || { echo "âŒ Frontend push failed"; exit 1; }
          # Tag and push as latest only if the above succeeded
          docker tag $REGISTRY/$REPOSITORY:$IMAGE_TAG $REGISTRY/$REPOSITORY:latest || { echo "âŒ Frontend tag failed"; exit 1; }
          docker push $REGISTRY/$REPOSITORY:latest || { echo "âŒ Frontend push latest failed"; exit 1; }
          echo "âœ… Vue.js frontend image pushed successfully"
      
      - name: Build summary
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker images built and pushed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vue.js Frontend Image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  release:
    name: Create Versioned Release
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate version tag
        id: version
        run: |
          # Generate version based on date and time: v2026.02.16-143052
          VERSION="v$(date -u +'%Y.%m.%d-%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Generated version: $VERSION"
      
      - name: Create and push git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.version }} -m "Automated release ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.version }}
          echo "âœ… Git tag created and pushed"
      
      - name: Generate release notes
        id: release_notes
        run: |
          # Get the last tag (excluding the one we just created)
          PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -v "${{ steps.version.outputs.version }}" | head -n 1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release
            echo "Initial automated release" > notes.txt
          else
            # Generate changelog from commits since last tag
            echo "Changes since $PREVIOUS_TAG:" > notes.txt
            echo "" >> notes.txt
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%an)" --no-merges >> notes.txt
          fi
          
          # Add build information
          echo "" >> notes.txt
          echo "" >> notes.txt
          echo "## Build Information" >> notes.txt
          echo "- **Commit**: ${{ github.sha }}" >> notes.txt
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> notes.txt
          echo "- **Triggered by**: ${{ github.actor }}" >> notes.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: notes.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2
      
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Tag ECR images with release version
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
          BACKEND_REPO: ${{ secrets.ECR_REGISTRY_BACKEND }}
          FRONTEND_REPO: ${{ secrets.ECR_REGISTRY_FRONTEND }}
          SHA_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ·ï¸  Tagging ECR images with release version: $VERSION"
          
          # Pull the images that were built with SHA tag
          echo "Pulling backend image..."
          docker pull $REGISTRY/$BACKEND_REPO:$SHA_TAG
          
          echo "Pulling frontend image..."
          docker pull $REGISTRY/$FRONTEND_REPO:$SHA_TAG
          
          # Tag backend with release version
          echo "Tagging backend image..."
          docker tag $REGISTRY/$BACKEND_REPO:$SHA_TAG $REGISTRY/$BACKEND_REPO:$VERSION
          docker push $REGISTRY/$BACKEND_REPO:$VERSION
          
          # Tag frontend with release version
          echo "Tagging frontend image..."
          docker tag $REGISTRY/$FRONTEND_REPO:$SHA_TAG $REGISTRY/$FRONTEND_REPO:$VERSION
          docker push $REGISTRY/$FRONTEND_REPO:$VERSION
          
          echo "âœ… ECR images tagged with $VERSION"
      
      - name: Release summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ECR Images Tagged:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_BACKEND }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REGISTRY_FRONTEND }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the release at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
